<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout1}">

<th:block layout:fragment="css">
	<style>
</style>
</th:block>

<th:block layout:fragment="script">
	<script th:inline="javascript">
		$(document).ready(function() {
			
			var IMP = window.IMP; 
		    IMP.init('imp32626541');
		    
		    /* $("#searchBtn").on("click", function(e) {
		        e.preventDefault();
		        page(0);
		    }); */
		});
		
		function requestPay(num, name, price) {
		    IMP.request_pay({
		    	pg: "kcp.store-24677c12-63",
		        pay_method: "card",
		        merchant_uid: num,
		        name: name,
		        amount: price
		    }, function (rsp) { // callback
		    	if ( rsp.success ) {
		   	      // 결제 성공 시 로직
		   	      alert('결제가 완료되었습니다.');
		   	      // DB에 결과 저장 로직 구현
		   	      
				  document.getElementById('frm').submit();
		   	      
		   	    } else {
		   	      // 결제 실패 시 로직
		   	      var msg = '결제에 실패하였습니다.';
		   	      msg += '에러내용 : ' + rsp.error_msg;
		   	      alert(msg);
		   	    }
		    });
		}
		/* function page(page) {
		    /* var searchDateType = $("#searchDateType").val();
		    var stat = $("#stat").val();
		    var searchBy = $("#searchBy").val();
		    var searchQuery = $("#searchQuery").val(); 
		    location.href = "/admin/reservationMng/" + page + "?searchDateType=" +
		        searchDateType + "&stat=" + stat +
		        "&searchBy=" + searchBy + "&searchQuery=" + searchQuery
		} */
	</script>
</th:block>

<div layout:fragment="content">
	<link th:href="@{/css/vocList.css}" rel="stylesheet">
	<div>
		<div class="vocList-title">
			<h3>예매관리</h3>
		</div>
		<div class="vocList-container">
			<form class="memberMngForm" role="form" method="post" action="/admin/searchMember">
				<select th:name="searchOption" class="memberMng-select">
					<option th:value="id">아이디
				</select> <input name="memberMngSearch" type="text">
				<button type="submit">검색</button>
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
			</form>

			<section class="vocList">
				<table class="vocList-table">
					<thead>
						<tr class="voc-tr">
							<td class="vocList-num">예매번호</td>
							<td class="vocList-name">상품명</td>
							<td class="vocList-rdate">예매일</td>
							<td class="vocList-udate">공연일</td>
							<td class="vocList-memberNum">예매자</td>
							<td class="vocList-stat">상태</td>
						</tr>
					</thead>
					<tbody>
						<tr th:each="reservation : ${reservations}">
							<td class="vocList-num" th:text="${reservation.num}"></td>
							<td class="vocList-name" th:text="${reservation.application.name}"></td>
							<td class="vocList-rdate" th:text="${reservation.rdate}"></td>
							<td class="vocList-udate" th:text="${reservation.application.udate}"></td>
							<td class="vocList-memberNum" th:text="${reservation.member.id}"></td>
							<td class="vocList-stat" th:text="${reservation.stat}"></td>
							<td sec:authorize="hasAnyAuthority('ROLE_ADMIN')">
								<button type="submit" th:formaction="@{/reservations/delete/{num}(num=${reservation.num})}">삭제하기</button>
							</td>
							<td sec:authorize="hasAnyAuthority('ROLE_ADMIN')">
							<form method="post" th:action="@{/pays/new/{num}(num=${reservation.num})}" id="frm" onsubmit="return false">
								<button th:onclick="requestPay([[${reservation.num}]], [[${reservation.application.name}]], [[${reservation.price}]])">결제하기</button>
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							</form>
							</td>
							<input type="hidden" th:value="${reservation.num}" id="num" >
							<input type="hidden" th:value="${reservation.application.name}" id="name" >
							<input type="hidden" th:value="${reservation.price}" id="price" >
						</tr>
					</tbody>
				</table>
				<br>
				<div class="page_wrap">

					<ul class="pagination justify-content-center">

						<li class="page-item"
							th:classappend="${startPage == reservations.pageable.pageNumber + 1} ? 'disabled'">
							<a class="page-link"
							th:href="@{/admin/reservationMng(page=${reservations.pageable.pageNumber - 1})}"
							tabindex="-1" aria-disabled="true">Previous</a>
						</li>


						<li class="page-item"
							th:classappend="${page == reservations.pageable.pageNumber + 1} ? 'active'"
							th:each="page : ${#numbers.sequence(startPage, endPage)}"><a
							class="page-link"
							th:href="@{/admin/reservationMng(page=${page-1})}"
							th:text=${page} aria-current="page">1</a></li>


						<li class="page-item"
							th:classappend="${endPage == reservations.pageable.pageNumber + 1} ? 'disabled'">
							<a class="page-link"
							th:href="@{/admin/reservationMng(page=${reservations.pageable.pageNumber + 1})}">Next</a>
						</li>

					</ul>

				</div>
			</section>
		</div>
	</div>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
	<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</div>